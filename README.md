# MP4文件处理工具

一个基于Node.js的命令行工具，用于批量处理MP4文件，支持自动压缩和分类管理。

## 功能特性

- 🔍 自动扫描当前目录下的所有MP4文件
- 📏 检测视频分辨率，小于720P的文件直接归档
- 🎬 识别横屏/竖屏视频，采用不同的压缩策略
- 🗜️ 使用FFmpeg进行高质量压缩（H.264 + AAC）
- 📁 自动创建和管理文件夹（Done/Processed/Error）
- ♻️ 持续处理直到目录清空

## 安装要求

### 系统依赖
- Node.js >= 16.0.0
- FFmpeg（包含ffprobe）
- pnpm包管理器

### 安装FFmpeg（macOS）
```bash
brew install ffmpeg
```

### 安装项目依赖
```bash
pnpm install
```

## 安装和使用

### 全局安装（推荐）

1. **一键安装**:
   ```bash
   ./install-global.sh
   ```

2. **在任意目录使用**:
   ```bash
   # 处理当前目录下的MP4文件
   mp4-compresser
   
   # 指定其他目录
   mp4-compresser -d "/path/to/your/video/directory"
   
   # 查看帮助
   mp4-compresser --help
   ```

3. **卸载全局命令**:
   ```bash
   pnpm unlink --global mp4-compresser
   ```

### 本地使用

如果不想全局安装，也可以在项目目录下直接运行：

```bash
# 使用默认目录
node index.js

# 指定其他目录
node index.js -d "/path/to/your/video/directory"
```

## 处理逻辑

1. **扫描文件**: 查找当前目录下所有.mp4/.MP4文件
2. **验证文件**: 使用ffprobe检查文件是否为有效视频
3. **分辨率检查**: 
   - 较短边 ≤ 720: 直接移动到`Done/`目录
   - 较短边 > 720: 进行压缩处理
4. **压缩设置**:
   - 横屏视频: 缩放到1280x720，保持宽高比
   - 竖屏视频: 缩放到720x1280，保持宽高比
   - 比例处理: 自动添加黑边保持目标尺寸
   - 编码: H.264 (libx264) + AAC音频
5. **文件管理**:
   - 压缩后的文件: 保存到`Done/`目录
   - 原始文件: 移动到`Processed/`目录
   - 无效文件: 移动到`Error/`目录

## 目录结构

处理完成后会在工作目录下自动创建以下子目录：

```
工作目录/
├── *.mp4          # 待处理的MP4文件
├── Done/          # 处理完成的视频文件
├── Processed/     # 已处理的原始文件
└── Error/         # 无效或处理失败的文件
```

## 注意事项

- 确保有足够的磁盘空间进行压缩操作
- 大文件压缩可能需要较长时间
- 建议在处理前备份重要文件
- 工具会持续运行直到当前目录没有MP4文件

## 故障排除

如果遇到问题，请检查：
1. FFmpeg是否正确安装：`ffmpeg -version`
2. 文件权限是否足够
3. 磁盘空间是否充足
4. 视频文件是否损坏